<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LiveList - Broadcast Manager</title>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;
        const Plus = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>;
        const Edit2 = () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>;
        const Trash2 = () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>;
        const Calendar = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>;

        if (typeof window.storage === 'undefined') {
            window.storage = {
                async get(key) { const v = localStorage.getItem(key); return v ? {key, value: v, shared: false} : null; },
                async set(key, value) { localStorage.setItem(key, value); return {key, value, shared: false}; },
                async delete(key) { localStorage.removeItem(key); return {key, deleted: true, shared: false}; },
                async list(prefix) { const keys = Object.keys(localStorage).filter(k => !prefix || k.startsWith(prefix)); return {keys, prefix, shared: false}; }
            };
        }

        const parseTime = (timeStr) => {
            if (!timeStr || !timeStr.includes(':')) return 0;
            const [h, m] = timeStr.split(':').map(Number);
            return h * 60 + m;
        };

        const formatOffset = (min) => {
            const sign = min < 0 ? '-' : '+';
            const abs = Math.abs(min);
            const h = Math.floor(abs / 60);
            const m = abs % 60;
            return `${sign}${h}:${String(m).padStart(2, '0')}`;
        };

        const formatCheckboxTime = (startTime, offsetMin) => {
            const startMin = parseTime(startTime);
            const actionMin = startMin + offsetMin;
            const h = Math.floor(actionMin / 60) % 24;
            const m = actionMin % 60;
            return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
        };

        const parseImportData = (text) => {
            const lines = text.trim().split('\n');
            if (lines.length < 1) return [];
            const groupedData = {};
            
            for (let i = 0; i < lines.length; i++) {
                const parts = lines[i].split('\t');
                if (parts.length < 13) continue;
                const [day, broadcast, ch, start, end, booth, fp, crew, lang, , , , game, info] = parts;
                const cleanGame = game ? game.trim().replace(/\s+/g, ' ') : '';
                if (!start || !cleanGame) continue;
                
                if (!groupedData[cleanGame]) {
                    groupedData[cleanGame] = {
                        id: Date.now() + Math.random(), date: day, channel: ch.trim(),
                        startTime: start, endTime: end, gameName: cleanGame, info: info || '',
                        template: 'football', crews: [], remarks: ''
                    };
                }
                // Remove spaces from FP (flypack) data
                const cleanFp = fp ? fp.replace(/\s+/g, '') : '';
                if (crew && crew.trim()) groupedData[cleanGame].crews.push({booth, fp: cleanFp, crew, lang});
            }
            
            return Object.values(groupedData).map(event => {
                const nlCrew = event.crews.find(c => c.lang && c.lang.includes('NL'));
                const frCrew = event.crews.find(c => c.lang && c.lang.includes('FR'));
                return {
                    ...event, boothNL: nlCrew?.booth || '', crewNL: nlCrew?.crew || '', fpNL: nlCrew?.fp || '',
                    boothFR: frCrew?.booth || '', crewFR: frCrew?.crew || '', fpFR: frCrew?.fp || '',
                    isActive: event.crews.length > 1,
                    checks: {boothCheck: false, nlIn: false, nlSync: false, frIn: false, frSync: false, goingLive: false}
                };
            });
        };

        function App() {
            const [view, setView] = useState('dashboard');
            const [currentTime, setCurrentTime] = useState(new Date());
            const [selectedDate, setSelectedDate] = useState('');
            const [templates, setTemplates] = useState([]);
            const [events, setEvents] = useState([]);

            useEffect(() => {
                loadTemplates(); loadEvents();
                const timer = setInterval(() => setCurrentTime(new Date()), 1000);
                const switchHandler = () => setView('dashboard');
                window.addEventListener('switchToDashboard', switchHandler);
                return () => {
                    clearInterval(timer);
                    window.removeEventListener('switchToDashboard', switchHandler);
                };
            }, []);

            useEffect(() => {
                if (events.length > 0 && !selectedDate) {
                    const sorted = [...events].sort((a, b) => parseTime(a.startTime) - parseTime(b.startTime));
                    if (sorted[0]) {
                        const match = sorted[0].date.match(/(\d+)-(\w+)/);
                        if (match) {
                            const monthMap = {jan:'01',feb:'02',mar:'03',apr:'04',may:'05',jun:'06',jul:'07',aug:'08',sep:'09',oct:'10',nov:'11',dec:'12'};
                            const monthNum = monthMap[match[2].toLowerCase()] || '01';
                            setSelectedDate(`2025-${monthNum}-${match[1].padStart(2,'0')}`);
                        }
                    }
                }
            }, [events, selectedDate]);

            const loadTemplates = async () => {
                try {
                    const result = await window.storage.list('template:');
                    if (result?.keys?.length > 0) {
                        const loaded = await Promise.all(result.keys.map(async (key) => {
                            try { const item = await window.storage.get(key); return item ? JSON.parse(item.value) : null; }
                            catch { return null; }
                        }));
                        setTemplates(loaded.filter(t => t !== null));
                    } else {
                        const def = {id:'football',name:'Football Match',boothCheckOffset:-90,crewInOffset:-75,syncTestOffset:-60,goingLiveOffset:-10,halfTimeOffset:50};
                        await window.storage.set('template:football', JSON.stringify(def));
                        setTemplates([def]);
                    }
                } catch (e) { console.log('Error loading templates'); }
            };

            const loadEvents = async () => {
                try {
                    const result = await window.storage.list('event:');
                    if (result?.keys) {
                        const loaded = await Promise.all(result.keys.map(async (key) => {
                            try { const item = await window.storage.get(key); return item ? JSON.parse(item.value) : null; }
                            catch { return null; }
                        }));
                        setEvents(loaded.filter(e => e !== null));
                    }
                } catch (e) { console.log('No events'); }
            };

            const saveTemplate = async (t) => { await window.storage.set(`template:${t.id}`, JSON.stringify(t)); await loadTemplates(); };
            const deleteTemplate = async (id) => { await window.storage.delete(`template:${id}`); await loadTemplates(); };
            const saveEvent = async (e) => { await window.storage.set(`event:${e.id}`, JSON.stringify(e)); await loadEvents(); };
            const deleteEvent = async (id) => { await window.storage.delete(`event:${id}`); await loadEvents(); };
            const importEvents = async (evts) => { for (const e of evts) await saveEvent(e); };

            return (
                <div className="min-h-screen bg-gray-100">
                    <header className="bg-gradient-to-r from-blue-600 via-blue-700 to-blue-600 text-white shadow-lg">
                        <div className="max-w-full mx-auto px-4 py-3">
                            <div className="flex justify-between items-center">
                                <button onClick={() => setView('dashboard')}
                                    className={`px-4 py-2 rounded-lg font-medium transition-colors ${view === 'dashboard' ? 'bg-white text-blue-700' : 'bg-blue-500 hover:bg-blue-400'}`}>
                                    Dashboard
                                </button>
                                <div className="text-3xl font-mono bg-black text-white px-4 py-2 rounded-lg font-bold">
                                    {currentTime.toLocaleTimeString()}
                                </div>
                                <div className="flex gap-3">
                                    <button onClick={() => setView('templates')}
                                        className={`px-4 py-2 rounded-lg font-medium transition-colors ${view === 'templates' ? 'bg-white text-blue-700' : 'bg-blue-500 hover:bg-blue-400'}`}>
                                        Templates
                                    </button>
                                    <button onClick={() => setView('import')}
                                        className={`px-4 py-2 rounded-lg font-medium transition-colors ${view === 'import' ? 'bg-white text-blue-700' : 'bg-blue-500 hover:bg-blue-400'}`}>
                                        Import
                                    </button>
                                </div>
                            </div>
                        </div>
                    </header>
                    <main className="max-w-full p-6">
                        {view === 'dashboard' && <Dashboard events={events} templates={templates} currentTime={currentTime} selectedDate={selectedDate} setSelectedDate={setSelectedDate} saveEvent={saveEvent} deleteEvent={deleteEvent} />}
                        {view === 'templates' && <TemplateManager templates={templates} saveTemplate={saveTemplate} deleteTemplate={deleteTemplate} />}
                        {view === 'import' && <ImportEvents importEvents={importEvents} />}
                    </main>
                </div>
            );
        }

        function Dashboard({events, templates, currentTime, selectedDate, setSelectedDate, saveEvent, deleteEvent}) {
            const [editingRemarks, setEditingRemarks] = useState(null);
            const [remarksValue, setRemarksValue] = useState('');

            const getFilteredEvents = () => {
                const selectedDay = parseInt(selectedDate.split('-')[2]);
                return events.filter(e => {
                    const dayMatch = e.date.match(/(\d+)-/);
                    const eventDay = dayMatch ? parseInt(dayMatch[1]) : 0;
                    return eventDay === selectedDay;
                }).sort((a, b) => {
                    const aTime = parseTime(a.startTime);
                    const bTime = parseTime(b.startTime);
                    const aAdj = aTime < 420 ? aTime + 1440 : aTime;
                    const bAdj = bTime < 420 ? bTime + 1440 : bTime;
                    return aAdj - bAdj;
                });
            };

            const toggleCheck = async (event, checkType) => {
                const updated = {...event};
                updated.checks[checkType] = !updated.checks[checkType];
                await saveEvent(updated);
            };

            const getTemplate = (event) => templates.find(t => t.id === event.template) || templates[0];

            const shouldHighlight = (event, checkType) => {
                if (!event.isActive || event.checks[checkType]) return false;
                const template = getTemplate(event);
                if (!template) return false;
                const startMin = parseTime(event.startTime);
                let currentMin = currentTime.getHours() * 60 + currentTime.getMinutes();
                const adjStart = startMin < 420 ? startMin + 1440 : startMin;
                const adjCurrent = currentMin < 420 ? currentMin + 1440 : currentMin;
                let triggerTime;
                if (checkType === 'boothCheck') triggerTime = adjStart + template.boothCheckOffset;
                else if (checkType === 'nlIn' || checkType === 'frIn') triggerTime = adjStart + template.crewInOffset;
                else if (checkType === 'nlSync' || checkType === 'frSync') triggerTime = adjStart + template.syncTestOffset;
                else if (checkType === 'goingLive') triggerTime = adjStart + template.goingLiveOffset;
                else return false;
                return adjCurrent >= triggerTime;
            };

            const getCheckboxClass = (event, checkType) => {
                // Check if event has ended (post end time)
                const endMin = parseTime(event.endTime);
                let currentMin = currentTime.getHours() * 60 + currentTime.getMinutes();
                const adjEnd = endMin < 420 ? endMin + 1440 : endMin;
                const adjCurrent = currentMin < 420 ? currentMin + 1440 : currentMin;
                if (adjCurrent >= adjEnd) return 'bg-gray-300 text-gray-500 cursor-not-allowed w-full h-full flex items-center justify-center';
                
                if (!event.isActive) return 'bg-gray-300 text-gray-500 cursor-not-allowed w-full h-full flex items-center justify-center';
                
                if (event.checks[checkType]) return 'bg-white text-green-700 w-full h-full flex items-center justify-center font-bold';
                if (shouldHighlight(event, checkType)) return 'bg-yellow-300 text-black w-full h-full flex items-center justify-center font-bold';
                return 'bg-white text-black hover:bg-gray-50 w-full h-full flex items-center justify-center cursor-pointer';
            };

            const getEventStatusColor = (event) => {
                if (!event.isActive) return '';
                const startMin = parseTime(event.startTime);
                const endMin = parseTime(event.endTime);
                let currentMin = currentTime.getHours() * 60 + currentTime.getMinutes();
                const adjStart = startMin < 420 ? startMin + 1440 : startMin;
                const adjEnd = endMin < 420 ? endMin + 1440 : endMin;
                const adjCurrent = currentMin < 420 ? currentMin + 1440 : currentMin;
                const template = getTemplate(event);
                if (adjCurrent < adjStart + (template?.boothCheckOffset || -90)) return 'bg-orange-200';
                if (adjCurrent < adjStart) return 'bg-orange-300';
                if (adjCurrent >= adjStart && adjCurrent < adjStart + 5) return 'bg-green-500 text-white font-bold';
                if (adjCurrent < adjStart + 30) return 'bg-green-200';
                const halfTime = adjStart + (template?.halfTimeOffset || 50);
                if (adjCurrent >= halfTime && adjCurrent < halfTime + 30) return 'bg-green-600 text-white font-bold';
                if (adjCurrent < adjEnd) return 'bg-green-700 text-white font-bold';
                return 'bg-gray-400 text-gray-300';
            };

            const saveRemarks = async (event) => {
                await saveEvent({...event, remarks: remarksValue});
                setEditingRemarks(null);
            };

            const deleteDay = async () => {
                if (!selectedDate) return;
                const selectedDay = parseInt(selectedDate.split('-')[2]);
                const toDelete = events.filter(e => {
                    const dayMatch = e.date.match(/(\d+)-/);
                    const eventDay = dayMatch ? parseInt(dayMatch[1]) : 0;
                    return eventDay === selectedDay;
                });
                if (toDelete.length === 0) { alert('No events to delete'); return; }
                if (confirm(`Delete all ${toDelete.length} event(s) for this day? This cannot be undone.`)) {
                    for (const event of toDelete) await deleteEvent(event.id);
                }
            };

            const filteredEvents = getFilteredEvents();

            return (
                <div>
                    <div className="mb-6 flex items-center gap-4 bg-white p-4 rounded-lg shadow">
                        <Calendar />
                        <input type="date" value={selectedDate} onChange={(e) => setSelectedDate(e.target.value)} className="px-4 py-2 border rounded-lg" />
                        <span className="text-gray-600">Showing {filteredEvents.length} event(s)</span>
                        <button onClick={deleteDay} className="ml-auto bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 flex items-center gap-2">
                            <Trash2 /> Erase Day
                        </button>
                    </div>
                    <div className="bg-white rounded-lg shadow-lg overflow-x-auto">
                        <table className="w-full text-sm border-collapse">
                            <thead className="bg-gray-100 sticky top-0">
                                <tr>
                                    <th className="border border-gray-300 px-2 py-2">CHANNEL</th>
                                    <th className="border border-gray-300 px-2 py-2">BOOTH</th>
                                    <th className="border border-gray-300 px-2 py-2 text-blue-600">BTH NL</th>
                                    <th className="border border-gray-300 px-2 py-2 text-blue-600">IN</th>
                                    <th className="border border-gray-300 px-2 py-2 text-blue-600">CREW NL</th>
                                    <th className="border border-gray-300 px-2 py-2 text-blue-600">SYNC</th>
                                    <th className="border border-gray-300 px-2 py-2 text-blue-600">FP NL</th>
                                    <th className="border border-gray-300 px-2 py-2 text-red-600">BTH FR</th>
                                    <th className="border border-gray-300 px-2 py-2 text-red-600">IN</th>
                                    <th className="border border-gray-300 px-2 py-2 text-red-600">CREW FR</th>
                                    <th className="border border-gray-300 px-2 py-2 text-red-600">SYNC</th>
                                    <th className="border border-gray-300 px-2 py-2 text-red-600">FP FR</th>
                                    <th className="border border-gray-300 px-2 py-2">LIVE</th>
                                    <th className="border border-gray-300 px-2 py-2">START</th>
                                    <th className="border border-gray-300 px-2 py-2 min-w-[300px]">GAME</th>
                                    <th className="border border-gray-300 px-2 py-2">END</th>
                                    <th className="border border-gray-300 px-2 py-2">INFO</th>
                                    <th className="border border-gray-300 px-2 py-2 min-w-[150px]">REMARKS</th>
                                    <th className="border border-gray-300 px-2 py-2">DEL</th>
                                </tr>
                            </thead>
                            <tbody>
                                {filteredEvents.map(event => {
                                    const statusColor = getEventStatusColor(event);
                                    const isInactive = !event.isActive;
                                    const template = getTemplate(event);
                                    return (
                                        <tr key={event.id} className={isInactive ? 'bg-white text-gray-300' : ''}>
                                            <td className="border px-2 py-2">{event.channel}</td>
                                            <td className="border px-0 py-0 text-center h-full">
                                                {isInactive ? <div className="px-2 py-2 h-full flex items-center justify-center">--</div> : (
                                                    <button onClick={() => toggleCheck(event,'boothCheck')}
                                                        className={`px-2 py-2 font-mono text-sm ${getCheckboxClass(event,'boothCheck')}`}>
                                                        {formatCheckboxTime(event.startTime, template?.boothCheckOffset || -90)}
                                                    </button>
                                                )}
                                            </td>
                                            <td className="border px-2 py-2 text-center text-blue-600">{isInactive ? '--' : event.boothNL}</td>
                                            <td className="border px-0 py-0 text-center h-full">
                                                {isInactive ? <div className="px-2 py-2 h-full flex items-center justify-center">--</div> : (
                                                    <button onClick={() => toggleCheck(event,'nlIn')}
                                                        className={`px-2 py-2 font-mono text-sm ${getCheckboxClass(event,'nlIn')}`}>
                                                        {formatCheckboxTime(event.startTime, template?.crewInOffset || -75)}
                                                    </button>
                                                )}
                                            </td>
                                            <td className="border px-2 py-2 text-blue-600">{isInactive ? '--' : event.crewNL}</td>
                                            <td className="border px-0 py-0 text-center h-full">
                                                {isInactive ? <div className="px-2 py-2 h-full flex items-center justify-center">--</div> : (
                                                    <button onClick={() => toggleCheck(event,'nlSync')}
                                                        className={`px-2 py-2 font-mono text-sm ${getCheckboxClass(event,'nlSync')}`}>
                                                        {formatCheckboxTime(event.startTime, template?.syncTestOffset || -60)}
                                                    </button>
                                                )}
                                            </td>
                                            <td className="border px-2 py-2 text-center text-blue-600">{isInactive ? '--' : event.fpNL}</td>
                                            <td className="border px-2 py-2 text-center text-red-600">{isInactive ? '--' : event.boothFR}</td>
                                            <td className="border px-0 py-0 text-center h-full">
                                                {isInactive ? <div className="px-2 py-2 h-full flex items-center justify-center">--</div> : (
                                                    <button onClick={() => toggleCheck(event,'frIn')}
                                                        className={`px-2 py-2 font-mono text-sm ${getCheckboxClass(event,'frIn')}`}>
                                                        {formatCheckboxTime(event.startTime, template?.crewInOffset || -75)}
                                                    </button>
                                                )}
                                            </td>
                                            <td className="border px-2 py-2 text-red-600">{isInactive ? '--' : event.crewFR}</td>
                                            <td className="border px-0 py-0 text-center h-full">
                                                {isInactive ? <div className="px-2 py-2 h-full flex items-center justify-center">--</div> : (
                                                    <button onClick={() => toggleCheck(event,'frSync')}
                                                        className={`px-2 py-2 font-mono text-sm ${getCheckboxClass(event,'frSync')}`}>
                                                        {formatCheckboxTime(event.startTime, template?.syncTestOffset || -60)}
                                                    </button>
                                                )}
                                            </td>
                                            <td className="border px-2 py-2 text-center text-red-600">{isInactive ? '--' : event.fpFR}</td>
                                            <td className="border px-0 py-0 text-center h-full">
                                                {isInactive ? <div className="px-2 py-2 h-full flex items-center justify-center">--</div> : (
                                                    <button onClick={() => toggleCheck(event,'goingLive')}
                                                        className={`px-2 py-2 font-mono text-sm ${getCheckboxClass(event,'goingLive')}`}>
                                                        {formatCheckboxTime(event.startTime, template?.goingLiveOffset || -10)}
                                                    </button>
                                                )}
                                            </td>
                                            <td className={`border px-2 py-2 text-center font-mono ${statusColor}`}>{event.startTime}</td>
                                            <td className={`border px-2 py-2 ${statusColor}`}>{event.gameName}</td>
                                            <td className={`border px-2 py-2 text-center font-mono ${statusColor}`}>{event.endTime}</td>
                                            <td className={`border px-2 py-2 text-xs ${event.info && event.info.trim() ? 'bg-orange-400 font-bold' : ''}`}>
                                                {event.info}
                                            </td>
                                            <td className="border px-2 py-2">
                                                {editingRemarks === event.id ? (
                                                    <input type="text" value={remarksValue} onChange={(e) => setRemarksValue(e.target.value)}
                                                        onBlur={() => saveRemarks(event)} onKeyDown={(e) => e.key === 'Enter' && saveRemarks(event)}
                                                        autoFocus className="w-full px-2 py-1 border border-blue-500 rounded" />
                                                ) : (
                                                    <div onClick={() => !isInactive && (setEditingRemarks(event.id), setRemarksValue(event.remarks || ''))}
                                                        className="cursor-pointer hover:bg-gray-50 px-2 py-1 rounded min-h-[24px]">
                                                        {event.remarks || (isInactive ? '--' : 'Click...')}
                                                    </div>
                                                )}
                                            </td>
                                            <td className="border px-2 py-2 text-center">
                                                <button onClick={() => confirm('Delete?') && deleteEvent(event.id)} className="text-red-600 hover:text-red-800"><Trash2 /></button>
                                            </td>
                                        </tr>
                                    );
                                })}
                            </tbody>
                        </table>
                    </div>
                    {filteredEvents.length === 0 && (
                        <div className="text-center py-12 bg-white rounded-lg shadow-lg mt-6">
                            <p className="text-lg text-gray-500">No events for this date</p>
                        </div>
                    )}
                </div>
            );
        }

        function TemplateManager({templates, saveTemplate, deleteTemplate}) {
            const [editing, setEditing] = useState(null);
            const [formData, setFormData] = useState({id:'',name:'',boothCheckOffset:-90,crewInOffset:-75,syncTestOffset:-60,goingLiveOffset:-10,halfTimeOffset:50});

            const startEdit = (t) => {
                setFormData(t || {id:Date.now().toString(),name:'',boothCheckOffset:-90,crewInOffset:-75,syncTestOffset:-60,goingLiveOffset:-10,halfTimeOffset:50});
                setEditing(true);
            };

            const handleSave = async () => {
                if (!formData.name) { alert('Name required'); return; }
                await saveTemplate(formData);
                setEditing(false);
            };

            return (
                <div>
                    <div className="mb-6">
                        <button onClick={() => startEdit(null)} className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 flex items-center gap-2">
                            <Plus /> Create Template
                        </button>
                    </div>
                    {editing && (
                        <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
                            <h2 className="text-xl font-bold mb-4">{templates.find(t => t.id === formData.id) ? 'Edit' : 'Create'} Template</h2>
                            <div className="space-y-4">
                                <div><label className="block text-sm font-medium mb-1">Name</label>
                                    <input type="text" value={formData.name} onChange={(e) => setFormData({...formData,name:e.target.value})} className="w-full px-4 py-2 border rounded-lg" /></div>
                                <div className="grid grid-cols-2 gap-4">
                                    {['boothCheckOffset','crewInOffset','syncTestOffset','goingLiveOffset','halfTimeOffset'].map(f => (
                                        <div key={f}><label className="block text-sm font-medium mb-1">{f.replace('Offset','').replace(/([A-Z])/g,' $1').trim()} (min)</label>
                                            <input type="number" value={f === 'halfTimeOffset' ? formData[f] : Math.abs(formData[f])}
                                                onChange={(e) => setFormData({...formData,[f]: f === 'halfTimeOffset' ? parseInt(e.target.value)||50 : -Math.abs(parseInt(e.target.value)||0)})}
                                                className="w-full px-4 py-2 border rounded-lg" /></div>
                                    ))}
                                </div>
                                <div className="flex gap-2">
                                    <button onClick={handleSave} className="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">Save</button>
                                    <button onClick={() => setEditing(false)} className="bg-gray-300 text-gray-700 px-6 py-2 rounded-lg hover:bg-gray-400">Cancel</button>
                                </div>
                            </div>
                        </div>
                    )}
                    <div className="space-y-4">
                        {templates.map(t => (
                            <div key={t.id} className="bg-white rounded-lg shadow-lg p-6">
                                <div className="flex justify-between items-start">
                                    <div>
                                        <h3 className="text-lg font-bold">{t.name}</h3>
                                        <div className="text-sm text-gray-600 mt-2 space-y-1">
                                            <div>Booth Check: KO {formatOffset(t.boothCheckOffset)}</div>
                                            <div>Crew In: KO {formatOffset(t.crewInOffset)}</div>
                                            <div>Sync Test: KO {formatOffset(t.syncTestOffset)}</div>
                                            <div>Going Live: KO {formatOffset(t.goingLiveOffset)}</div>
                                            <div>Half-time: KO +{t.halfTimeOffset} min</div>
                                        </div>
                                    </div>
                                    <div className="flex gap-2">
                                        <button onClick={() => startEdit(t)} className="text-blue-600 hover:text-blue-800 p-2"><Edit2 /></button>
                                        <button onClick={() => confirm('Delete?') && deleteTemplate(t.id)} className="text-red-600 hover:text-red-800 p-2"><Trash2 /></button>
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        }

        function ImportEvents({importEvents}) {
            const [pasteData, setPasteData] = useState('');
            const [preview, setPreview] = useState([]);

            const handleImport = async () => {
                if (preview.length === 0) return;
                await importEvents(preview);
                setPasteData(''); setPreview([]);
                // Switch to dashboard after import
                window.dispatchEvent(new CustomEvent('switchToDashboard'));
            };

            return (
                <div className="space-y-6">
                    <div className="bg-white rounded-lg shadow-lg p-6">
                        <h2 className="text-xl font-bold mb-4">Import Events from Spreadsheet</h2>
                        <div className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium mb-2">Paste data (no headers):</label>
                                <textarea value={pasteData} onChange={(e) => setPasteData(e.target.value)}
                                    className="w-full h-48 px-4 py-2 border rounded-lg font-mono text-sm"
                                    placeholder="Paste your spreadsheet data here..." />
                            </div>
                            <div className="flex gap-2">
                                {preview.length === 0 ? (
                                    <button onClick={() => setPreview(parseImportData(pasteData))} disabled={!pasteData.trim()}
                                        className="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 disabled:bg-gray-400">
                                        Parse Data
                                    </button>
                                ) : (
                                    <>
                                        <button onClick={handleImport} className="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700">
                                            Import {preview.length} Event(s)
                                        </button>
                                        <button onClick={() => {setPreview([]);setPasteData('');}}
                                            className="bg-gray-300 text-gray-700 px-6 py-2 rounded-lg hover:bg-gray-400">Cancel</button>
                                    </>
                                )}
                            </div>
                        </div>
                    </div>
                    {preview.length > 0 && (
                        <div className="bg-white rounded-lg shadow-lg p-6">
                            <h3 className="text-lg font-bold mb-4">Preview ({preview.length} events)</h3>
                            <div className="space-y-3 max-h-96 overflow-y-auto">
                                {preview.map((event, idx) => (
                                    <div key={idx} className={`border rounded-lg p-3 ${event.isActive ? 'border-blue-300 bg-blue-50' : 'border-gray-300 bg-gray-50'}`}>
                                        <div className="font-medium">{event.gameName}</div>
                                        <div className="text-sm text-gray-600 mt-1">{event.date} | {event.startTime} - {event.endTime} | {event.channel}</div>
                                        <div className="text-xs text-gray-500 mt-1">
                                            {event.isActive ? (
                                                <>NL: {event.crewNL} ({event.boothNL}, {event.fpNL}) | FR: {event.crewFR} ({event.boothFR}, {event.fpFR})</>
                                            ) : (
                                                <span className="text-orange-600">No crew - display only</span>
                                            )}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>